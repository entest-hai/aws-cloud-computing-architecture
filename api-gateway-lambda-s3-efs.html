<!DOCTYPE html>
<html>

<head>
	<title>readme.md</title>
	<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

	<style>
		/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
		/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

		body {
			font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
			font-size: var(--vscode-markdown-font-size, 14px);
			padding: 0 26px;
			line-height: var(--vscode-markdown-line-height, 22px);
			word-wrap: break-word;
			max-width: 64rem;
			margin: auto;
		}

		#code-csp-warning {
			position: fixed;
			top: 0;
			right: 0;
			color: white;
			margin: 16px;
			text-align: center;
			font-size: 12px;
			font-family: sans-serif;
			background-color: #444444;
			cursor: pointer;
			padding: 6px;
			box-shadow: 1px 1px 1px rgba(0, 0, 0, .25);
		}

		#code-csp-warning:hover {
			text-decoration: none;
			background-color: #007acc;
			box-shadow: 2px 2px 2px rgba(0, 0, 0, .25);
		}

		body.scrollBeyondLastLine {
			margin-bottom: calc(100vh - 22px);
		}

		body.showEditorSelection .code-line {
			position: relative;
		}

		body.showEditorSelection .code-active-line:before,
		body.showEditorSelection .code-line:hover:before {
			content: "";
			display: block;
			position: absolute;
			top: 0;
			left: -12px;
			height: 100%;
		}

		body.showEditorSelection li.code-active-line:before,
		body.showEditorSelection li.code-line:hover:before {
			left: -30px;
		}

		.vscode-light.showEditorSelection .code-active-line:before {
			border-left: 3px solid rgba(0, 0, 0, 0.15);
		}

		.vscode-light.showEditorSelection .code-line:hover:before {
			border-left: 3px solid rgba(0, 0, 0, 0.40);
		}

		.vscode-light.showEditorSelection .code-line .code-line:hover:before {
			border-left: none;
		}

		.vscode-dark.showEditorSelection .code-active-line:before {
			border-left: 3px solid rgba(255, 255, 255, 0.4);
		}

		.vscode-dark.showEditorSelection .code-line:hover:before {
			border-left: 3px solid rgba(255, 255, 255, 0.60);
		}

		.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
			border-left: none;
		}

		.vscode-high-contrast.showEditorSelection .code-active-line:before {
			border-left: 3px solid rgba(255, 160, 0, 0.7);
		}

		.vscode-high-contrast.showEditorSelection .code-line:hover:before {
			border-left: 3px solid rgba(255, 160, 0, 1);
		}

		.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
			border-left: none;
		}

		img {
			max-width: 100%;
			max-height: 100%;
		}

		a {
			text-decoration: none;
		}

		a:hover {
			text-decoration: underline;
		}

		a:focus,
		input:focus,
		select:focus,
		textarea:focus {
			outline: 1px solid -webkit-focus-ring-color;
			outline-offset: -1px;
		}

		hr {
			border: 0;
			height: 2px;
			border-bottom: 2px solid;
		}

		h1 {
			padding-bottom: 0.3em;
			line-height: 1.2;
			border-bottom-width: 1px;
			border-bottom-style: solid;
		}

		h1,
		h2,
		h3 {
			font-weight: normal;
		}

		table {
			border-collapse: collapse;
		}

		table>thead>tr>th {
			text-align: left;
			border-bottom: 1px solid;
		}

		table>thead>tr>th,
		table>thead>tr>td,
		table>tbody>tr>th,
		table>tbody>tr>td {
			padding: 5px 10px;
		}

		table>tbody>tr+tr>td {
			border-top: 1px solid;
		}

		blockquote {
			margin: 0 7px 0 5px;
			padding: 0 16px 0 10px;
			border-left-width: 5px;
			border-left-style: solid;
		}

		code {
			font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
			font-size: 1em;
			line-height: 1.357em;
		}

		body.wordWrap pre {
			white-space: pre-wrap;
		}

		pre:not(.hljs),
		pre.hljs code>div {
			padding: 16px;
			border-radius: 3px;
			overflow: auto;
		}

		pre code {
			color: var(--vscode-editor-foreground);
			tab-size: 4;
		}

		/** Theming */

		.vscode-light pre {
			background-color: rgba(220, 220, 220, 0.4);
		}

		.vscode-dark pre {
			background-color: rgba(10, 10, 10, 0.4);
		}

		.vscode-high-contrast pre {
			background-color: rgb(0, 0, 0);
		}

		.vscode-high-contrast h1 {
			border-color: rgb(0, 0, 0);
		}

		.vscode-light table>thead>tr>th {
			border-color: rgba(0, 0, 0, 0.69);
		}

		.vscode-dark table>thead>tr>th {
			border-color: rgba(255, 255, 255, 0.69);
		}

		.vscode-light h1,
		.vscode-light hr,
		.vscode-light table>tbody>tr+tr>td {
			border-color: rgba(0, 0, 0, 0.18);
		}

		.vscode-dark h1,
		.vscode-dark hr,
		.vscode-dark table>tbody>tr+tr>td {
			border-color: rgba(255, 255, 255, 0.18);
		}
	</style>

	<style>
		/* Tomorrow Theme */
		/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
		/* Original theme - https://github.com/chriskempson/tomorrow-theme */

		/* Tomorrow Comment */
		.hljs-comment,
		.hljs-quote {
			color: #8e908c;
		}

		/* Tomorrow Red */
		.hljs-variable,
		.hljs-template-variable,
		.hljs-tag,
		.hljs-name,
		.hljs-selector-id,
		.hljs-selector-class,
		.hljs-regexp,
		.hljs-deletion {
			color: #c82829;
		}

		/* Tomorrow Orange */
		.hljs-number,
		.hljs-built_in,
		.hljs-builtin-name,
		.hljs-literal,
		.hljs-type,
		.hljs-params,
		.hljs-meta,
		.hljs-link {
			color: #f5871f;
		}

		/* Tomorrow Yellow */
		.hljs-attribute {
			color: #eab700;
		}

		/* Tomorrow Green */
		.hljs-string,
		.hljs-symbol,
		.hljs-bullet,
		.hljs-addition {
			color: #718c00;
		}

		/* Tomorrow Blue */
		.hljs-title,
		.hljs-section {
			color: #4271ae;
		}

		/* Tomorrow Purple */
		.hljs-keyword,
		.hljs-selector-tag {
			color: #8959a8;
		}

		.hljs {
			display: block;
			overflow-x: auto;
			color: #4d4d4c;
			padding: 0.5em;
		}

		.hljs-emphasis {
			font-style: italic;
		}

		.hljs-strong {
			font-weight: bold;
		}
	</style>

	<style>
		/*
 * Markdown PDF CSS
 */

		body {
			font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
			padding: 0 12px;
		}

		pre {
			background-color: #f8f8f8;
			border: 1px solid #cccccc;
			border-radius: 3px;
			overflow-x: auto;
			white-space: pre-wrap;
			overflow-wrap: break-word;
		}

		pre:not(.hljs) {
			padding: 23px;
			line-height: 19px;
		}

		blockquote {
			background: rgba(127, 127, 127, 0.1);
			border-color: rgba(0, 122, 204, 0.5);
		}

		.emoji {
			height: 1.4em;
		}

		code {
			font-size: 14px;
			line-height: 19px;
		}

		/* for inline code */
		:not(pre):not(.hljs)>code {
			color: #C9AE75;
			/* Change the old color so it seems less like an error */
			font-size: inherit;
		}

		/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
		.page {
			page-break-after: always;
		}
	</style>

	<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>

<body>
	<script>
		mermaid.initialize({
			startOnLoad: true,
			theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
				? 'dark'
				: 'default'
		});
	</script>
	<h1 id="api-gateway---lambda---efs---s3">API Gateway - Lambda - EFS - S3</h1>
	<p><strong>23 DEC 2021 Hai Tran</strong></p>
	<h4 id="discussion">Discussion</h4>
	<p>I want to create a API endpoint to process data uploaded from users and stored in a S3 bucket. Here is something
		I did but not sure is this a good practice or not. So I would like to listen to comments.</p>
	<ul>
		<li>Lambda depdenccies is several GB so not able to zip and deploy, so I load dependencies from EFS <a
				href="https://aws.amazon.com/blogs/compute/building-deep-learning-inference-with-aws-lambda-and-amazon-efs/">reference</a>
		</li>
		<li>Since the Lambda is inside a VPC, it is not able to access S3. So I add a VPC S3 endpoint.</li>
	</ul>
	<h4 id="architecture">Architecture</h4>
	<p>I took Lambda over EC2 and ECS because the processing tasks requires 10GB RAM, 20 seconds, need to scale out, and
		the load is not always on. Also Lambda has no IP and port, process data without traverse the internet, easy to
		operate, and monitor. It can scale out by using a pool of multiple such as 10 Lambdas and keep warm, I don't
		like provisioned because the load/spike is unpredictable. However, this wwill needs some code to route/schedule
		requests (like a simple roud robin) to Lambdas. Is a simple round robin good and robust enough?</p>
	<p><img src="https://user-images.githubusercontent.com/20411077/147257529-8cc770e5-27b0-452d-8ea4-22d70b6b75b9.png"
			alt="aws-s3-vpc-endpoint (1)"></p>
	<h4 id="step-1-create-a-python-handler-just-to-check">Step 1. Create a python handler just to check</h4>
	<pre class="hljs"><code><div>def lambda_handler(event, context):
    # parse parameters 
    params = event[&quot;queryStringParameters&quot;][&quot;filename&quot;]
    # 
    return {
        'statusCode': 200,
        'body': json.dumps({'filename': params})
    }
</div></code></pre>
	<h4 id="step-2-check-cors-for-lambda-and-curl">Step 2. Check CORS for Lambda and curl</h4>
	<p>Need to add HEADER to the lambda handler</p>
	<pre class="hljs"><code><div>def lambda_handler(event, context):
    # parse parameters 
    filename = event[&quot;queryStringParameters&quot;][&quot;filename&quot;]
    # client s3 client to read an object from s3 
    s3Client = boto3.client(&quot;s3&quot;)
    items = s3Client.list_objects(
        Bucket='bucketname'
    )
    # response 
    return {
        'statusCode': 200,
        'headers': {
            &quot;Access-Control-Allow-Origin&quot;: &quot;*&quot;,
            &quot;Access-Control-Allow-Headers&quot;: &quot;Content-Type&quot;,
            &quot;Access-Control-Allow-Methods&quot;: &quot;OPTIONS,GET&quot;
        },
        'body': json.dumps({'filename': filename, 'item': items},  indent=4, sort_keys=True, default=str)    
    }
</div></code></pre>
	<h4 id="step-3-configure-lambda-access-a-s3-bucket">Step 3. Configure Lambda access a S3 bucket</h4>
	<ul>
		<li>Need a VPC endpoint.</li>
		<li>IAM role for the Lambda function to access S3 <a
				href="https://aws.amazon.com/premiumsupport/knowledge-center/lambda-execution-role-s3-bucket/">reference</a>
		</li>
	</ul>
	<pre class="hljs"><code><div>
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Sid&quot;: &quot;ExampleStmt&quot;,
      &quot;Action&quot;: [
        &quot;s3:GetObject&quot;
      ],
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Resource&quot;: [
        &quot;arn:aws:s3:::AWSDOC-EXAMPLE-BUCKET/*&quot;
      ]
    }
  ]
}
</div></code></pre>
	<h4 id="step-4-create-a-efs-endpoint">Step 4. Create a EFS endpoint</h4>
	<ul>
		<li>create a EFS file system
			<a
				href="https://aws.amazon.com/blogs/compute/using-amazon-efs-for-aws-lambda-in-your-serverless-applications/">Reference</a>
		</li>
		<li>create an access point
			<a
				href="https://aws.amazon.com/blogs/compute/using-amazon-efs-for-aws-lambda-in-your-serverless-applications/">Reference</a>
		</li>
		<li>CloudFormation template</li>
	</ul>
	<pre class="hljs"><code><div>  AccessPointResource:
    Type: 'AWS::EFS::AccessPoint'
    Properties:
      FileSystemId: !Ref FileSystemResource
      PosixUser:
        Uid: &quot;1000&quot;
        Gid: &quot;1000&quot;
      RootDirectory:
        CreationInfo:
          OwnerGid: &quot;1000&quot;
          OwnerUid: &quot;1000&quot;
          Permissions: &quot;0777&quot;
        Path: &quot;/efs&quot;
</div></code></pre>
	<h4 id="step-5-mount-efs-access-point-to-ec2">Step 5. Mount EFS access point to EC2</h4>
	<ul>
		<li>Install efs-utils for ubuntun <a href="https://github.com/aws/efs-utils">git repo</a></li>
		<li>mount the access point on an EC2 <a
				href="https://docs.aws.amazon.com/efs/latest/ug/efs-mount-helper.html">mount</a></li>
		<li><a href="https://docs.aws.amazon.com/efs/latest/ug/efs-access-points.html">mount access point command</a>
		</li>
		<li>ensure that EC2 and EFS is in the default security group</li>
	</ul>
	<pre class="hljs"><code><div>mount -t efs -o tls,accesspoint=fsap-12345678 fs-12345678: /localmountpoint
</div></code></pre>
	<h4 id="step-6-add-polcies-for-lambda">Step 6. Add polcies for Lambda</h4>
	<ul>
		<li>add VPC endpoint S3 because now this is the only way for Lambda to access S3</li>
		<li>policy to add the VPC</li>
		<li>policy to read and write the EFS</li>
		<li>policy to read the S3 bucket (just double check)</li>
		<li>test</li>
	</ul>
	<pre class="hljs"><code><div>import json
import boto3

def lambda_handler(event, context):
    # test read write EFS
    with open(&quot;/mnt/efs/data.txt&quot;, &quot;w&quot;) as file: 
        file.write(&quot;Hello from Lambda&quot;)
    # test lamba access s3 
    s3Client = boto3.client(&quot;s3&quot;)
    items = s3Client.list_objects(
        Bucket='haitran-swinburne-2021'
    )
    # parse parameters 
    filename = event[&quot;queryStringParameters&quot;][&quot;filename&quot;]
    # response 
    return {
        'statusCode': 200,
        'headers': {
            &quot;Access-Control-Allow-Origin&quot;: &quot;*&quot;,
            &quot;Access-Control-Allow-Headers&quot;: &quot;Content-Type&quot;,
            &quot;Access-Control-Allow-Methods&quot;: &quot;OPTIONS,GET&quot;
        },
         'body': json.dumps({'filename': filename, 'item': items},  indent=4, sort_keys=True, default=str)
    }

</div></code></pre>
	<h4 id="step-7-configure-lambda-load-dependencies-from-efs">Step 7. Configure Lambda load dependencies from EFS</h4>
	<ul>
		<li><a href="https://docs.aws.amazon.com/lambda/latest/dg/services-efs.html">recommendation and performance from
				AWS</a></li>
	</ul>
	<h4 id="reference">Reference</h4>
	<ol>
		<li><a href="https://aws.amazon.com/blogs/architecture/choosing-your-vpc-endpoint-strategy-for-amazon-s3/">Choosing
				Your VPC Endpoint Strategy for Amazon S3</a></li>
		<li><a
				href="https://aws.amazon.com/blogs/compute/building-deep-learning-inference-with-aws-lambda-and-amazon-efs/">Lambda
				EFS Deep Learning</a></li>
		<li><a
				href="https://aws.amazon.com/blogs/storage/managing-amazon-s3-access-with-vpc-endpoints-and-s3-access-points/">AWS
				S3 access with VPC endpoints</a></li>
		<li><a href="https://www.youtube.com/watch?v=uvKWJ4c1EYc&amp;t=549s">aws s3 vpc endpoint</a></li>
		<li><a href="https://www.alexdebrie.com/posts/aws-lambda-vpc/">three ways to use AWS services from</a></li>
	</ol>

</body>

</html>